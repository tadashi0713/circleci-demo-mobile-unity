version: 2.1

orbs:
  ruby: circleci/ruby@2.0.1
  unity: game-ci/unity@1.4.0

jobs:
  build-android:
    docker:
      - image: 'unityci/editor:ubuntu-2021.3.26f1-android-1'
        environment:
          - GAMECI_EDITOR_VERSION=2021.3.26f1
          - GAMECI_TARGET_PLATFORM=Android
    resource_class: tadashi0713/gameci-container-runner
    steps:
      - run: mkdir -p ~/.ssh      
      - run: ssh-keyscan github.com >> ~/.ssh/known_hosts
      - checkout
      - unity/prepare-env
      - unity/build:
          build-target: Android
          compress: false
          store-artifacts: false
      - persist_to_workspace:
          root: .
          paths:
            - Builds/Android

  beta-android:
    executor:
      name: ruby/default
      tag: 3.0.5
    steps:
      - checkout
      - attach_workspace:
          at: .
      - ruby/install-deps:
          key: android
      - run: bundle exec fastlane android beta

  export-ios:
    docker:
      - image: 'unityci/editor:ubuntu-2021.3.26f1-ios-1'
        environment:
          - GAMECI_EDITOR_VERSION=2021.3.26f1
          - GAMECI_TARGET_PLATFORM=iOS
    resource_class: tadashi0713/gameci-container-runner
    steps:
      - run: mkdir -p ~/.ssh      
      - run: ssh-keyscan github.com >> ~/.ssh/known_hosts
      - unity/prepare-env
      - unity/build:
          build-target: iOS
          compress: false
          store-artifacts: false
      - persist_to_workspace:
          root: .
          paths:
            - Builds/iOS/iOS

  build-and-beta-ios:
    macos:
      xcode: 14.3.1
    resource_class: macos.m1.large.gen1
    steps:
      - checkout
      - attach_workspace:
          at: .
      - ruby/install-deps:
          key: ios
      - run: bundle exec fastlane ios beta

workflows:
  build-unity-project:
    jobs:
      - build-android:
          context: unity
      - beta-android:
          requires:
            - build-android
          context:
            - mobile
      - export-ios:
          context: unity
      - build-and-beta-ios:
          requires:
            - export-ios
          context:
            - mobile
